<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="bt">PokeGad</title>
</head>

<body>
    <div style="height: 600px;width: 300px;background-color:antiquewhite;float: left;text-align: center;">
        <div style="background-color:rgb(255, 243, 80);">
            <br><b id="tileName">地图名</b><br><br>
        </div>
        <div style="background-color:coral;height: 200px;">
            地图元素列表
            <p id="asd"></p>
            <p id="zc"></p>
        </div>
        <div style="background-color:rgb(255, 243, 80);height: 150px;width: 150px;float: left;">
            <canvas height="150" width="150" id="HomePath"></canvas>
        </div>
        <div style="background-color:rgb(173, 255, 80);height: 150px;width: 150px;float: left;">
            <div style="height: 50px;width: 50px;background-color: aquamarine;float: left;"></div>
            <div style="height: 50px;width: 50px;float: left;">
                <button style="height: 50px;width: 50px;" id="Up" onclick="Up()">↑</button></div>
            <div style="height: 50px;width: 50px;background-color: aquamarine;float: left;"></div>
            <div style="height: 50px;width: 50px;float: left;">
                <button style="height: 50px;width: 50px;" id="Left" onclick="Left()">←</button></div>
            <div style="height: 50px;width: 50px;background-color: aquamarine;float: left;"></div>
            <div style="height: 50px;width: 50px;float: left;">
                <button style="height: 50px;width: 50px;" id="Right" onclick="Right()">→</button></div>
            <div style="height: 50px;width: 50px;background-color: aquamarine;float: left;"></div>
            <div style="height: 50px;width: 50px;float: left;">
                <button style="height: 50px;width: 50px;" id="Down" onclick="Down()">↓</button></div>
            <div style="height: 50px;width: 50px;background-color: aquamarine;float: left;"></div>
        </div>
        <p id="geZiShu"></p>
        <button onclick="ClearTiles()">重置</button>
    </div>

    <div style="height: 600px;width: 300px;background-color:aquamarine;float: left;text-align: center;">
        <p>
            百万格子地图<br>
            独家算法<br>
            多种精灵元素<br>
        </p>
    </div>

    <div style="height: 600px;width: 300px;background-color:antiquewhite;float: left;text-align: center;">
        <div style="height: 300px;width: 300px;float: left;">
            <canvas height="300" width="300" id="ceshi"></canvas>
        </div>
    </div>
</body>
<script>
    //动态网页标题
    var changeTitle = setInterval(function () { gaiBianBiaoTi() }, 3000)
    var i = new Boolean;
    function gaiBianBiaoTi() {
        if (i) { document.getElementById("bt").innerText = "Made By Gadsss"; i = false }
        else { document.getElementById("bt").innerText = "PokeGad"; i = true }
    }
    //地图数据
    if (!localStorage.tiles) { StartRanMap(50, 50, 0.6) }//初始化地图信息
    if (!localStorage.x) { localStorage.x = parseInt(localStorage.home.split(',')[0]) }
    if (!localStorage.y) { localStorage.y = parseInt(localStorage.home.split(',')[1]) }//初始化自身位置
    var tiles = new Array(); var ditu = localStorage.tiles.split(","); var jiditu = 0;//将地图信息保存到二维数组
    for (let i = 0; i < 50; i++) {
        tiles[i] = new Array();
        for (let o = 0; o < 50; o++) {
            tiles[i][o] = ditu[jiditu]; jiditu++;
        }
    }
    //这个坐标系向下是Y+，向右是X+
    var x = parseInt(localStorage.x); var y = parseInt(localStorage.y);//录入自己在地图中的位置
    var home = [parseInt(localStorage.home.split(',')[0]), parseInt(localStorage.home.split(',')[1])];//录入家的位置
    //开始
    window.onload = function Start() {//根据地图增加的行列重绘地图
        ReShow();
    }
    //刷新页面内容并保存，以及一些数据显示
    function ReShow() {
        document.getElementById("tileName").innerHTML = tiles[x][y]; Line2Home();
        localStorage.x = x; localStorage.y = y;
        document.getElementById("asd").innerHTML = x + "," + y;
        var hjLine = document.getElementById("ceshi").getContext("2d"); hjLine.clearRect(0, 0, 300, 300);
        for (let i = 0; i < 50; i++) {
            for (let o = 0; o < 50; o++) {
                if (tiles[i][o] == "陆地") {
                    hjLine.beginPath(); hjLine.strokeStyle = "#ff9900";
                    hjLine.arc(6 * i + 3, 6 * o + 3, 3, 0, 2 * Math.PI);//画陆地
                    hjLine.stroke();
                } else if (tiles[i][o] == "水") {
                    hjLine.beginPath(); hjLine.strokeStyle = "#0099ff";
                    hjLine.arc(6 * i + 3, 6 * o + 3, 3, 0, 2 * Math.PI);//画水
                    hjLine.stroke();
                } else if (tiles[i][o] == "家") {
                    hjLine.beginPath(); hjLine.strokeStyle = "#ff0000";
                    hjLine.arc(6 * i + 3, 6 * o + 3, 3, 0, 2 * Math.PI);//画家
                    hjLine.stroke();
                }
            }
        }
        hjLine.beginPath(); hjLine.fillStyle = "#000000";
        hjLine.arc(6 * x + 3, 6 * y + 3, 3, 0, 2 * Math.PI);//画人
        hjLine.fill();
    }
    //绘制主角到家的连线
    function Line2Home() {
        //画图，注意canvas的坐标系也是和我一样奇怪的
        var lX = 75 - (x - home[0]) * 10; var lY = 75 - (y - home[1]) * 10;//射线的方向
        var hjc = document.getElementById("HomePath");
        var hjLine = hjc.getContext("2d");
        hjLine.strokeStyle = "red"; hjLine.fillStyle = "red";
        hjLine.clearRect(0, 0, 150, 150);//清理canvas
        hjLine.beginPath();//创建或重置路径
        hjLine.arc(75, 75, 70, 0, 2 * Math.PI);
        hjLine.stroke(); //画外面的大圆 
        hjLine.clip();//切掉大圆以外的部分
        hjLine.beginPath();
        hjLine.moveTo(75, 75);
        hjLine.lineTo(lX, lY);
        hjLine.stroke(); //画人到家的连线
        hjLine.beginPath();
        hjLine.arc(lX, lY, 5, 0, 2 * Math.PI); //起点坐标，半径，起始角，结束角
        hjLine.stroke(); //画指示家的圆
        hjLine.beginPath();
        hjLine.arc(75, 75, 3, 0, 2 * Math.PI);
        hjLine.fill(); //画代表自己的填充圆   
    }
    //用四分法随机地图
    function StartRanMap(x, y, midu) {//x是地图宽，y是高，midu是密度（小数）
        var num = y / 2; var range = x / 2; var midus = [4];
        var way = Math.floor(Math.random() * 16).toString(2).split(""); var wl = 4 - way.length;
        for (let i = 0; i < wl; i++) {
            way.unshift('0');
        }
        for (let i = 0; i < 4; i++) {
            if (way[i] == 1) { midus[i] = (midu + 0.1) * num * range }
            if (way[i] == 0) { midus[i] = (midu - 0.1) * num * range }
        }
        RandomMap(num, range, midus);
    }
    function RandomMap(num, range, midus) {
        //定义二维数组
        var map = new Array();
        for (let i = 0; i < 2 * range; i++) {
            map[i] = new Array();
            for (let o = 0; o < 2 * num; o++) {
                map[i][o] = "水";
            }
        }
        //填充边界
        var zuoshang = chooseWant(num, range, midus[0]);
        for (let i = 0; i < num; i++) {
            map[range - 1 - zuoshang[i]][i] = "陆地";
        }
        var youshang = chooseWant(num, range, midus[1]);
        for (let i = 0; i < num; i++) {
            map[range + youshang[i]][i] = "陆地";
        }
        var zuoxia = chooseWant(num, range, midus[2]);
        for (let i = 0; i < num; i++) {
            map[range - 1 - zuoxia[num - 1 - i]][i + num] = "陆地";
        }
        var youxia = chooseWant(num, range, midus[3]);
        for (let i = 0; i < num; i++) {
            map[range + youxia[num - 1 - i]][i + num] = "陆地";
        }
        //填充中间值
        for (let o = 0; o < 2 * num; o++) {
            var tc = 0;
            for (let i = 0; i < 2 * range; i++) {
                if (map[i][o] == "陆地" & tc == 0) { tc = 1 }
                else if (map[i][o] == "陆地" & tc == 1) { tc = 0 }
                if (tc == 1) { map[i][o] = "陆地" }
            }
        }
        //随机初始点的位置
        var homepoint = Ran1point(num, range);
        while (map[homepoint[0]][homepoint[1]] != "陆地") {
            homepoint = Ran1point(num, range);
        }
        map[homepoint[0]][homepoint[1]] = "家";
        //绘制
        var hjLine = document.getElementById("ceshi").getContext("2d"); hjLine.clearRect(0, 0, 12 * range, 12 * num);
        for (let i = 0; i < 2 * range; i++) {
            for (let o = 0; o < 2 * num; o++) {
                if (map[i][o] == "陆地") {
                    hjLine.beginPath(); hjLine.strokeStyle = "#ff9900";
                    hjLine.arc(6 * i + 3, 6 * o + 3, 3, 0, 2 * Math.PI);//画陆地
                    hjLine.stroke();
                } else if (map[i][o] == "水") {
                    hjLine.beginPath(); hjLine.strokeStyle = "#0099ff";
                    hjLine.arc(6 * i + 3, 6 * o + 3, 3, 0, 2 * Math.PI);//画水
                    hjLine.stroke();
                } else if (map[i][o] == "家") {
                    hjLine.beginPath(); hjLine.strokeStyle = "#ff0000";
                    hjLine.arc(6 * i + 3, 6 * o + 3, 3, 0, 2 * Math.PI);//画水
                    hjLine.stroke();
                }
            }
        }
        localStorage.tiles = map; localStorage.home = homepoint;
        localStorage.x = homepoint[0]; localStorage.y = homepoint[1];

    }
    //生成一个在范围内的点
    function Ran1point(num, range) {
        return [Math.floor(Math.random() * range), Math.floor(Math.random() * num)]
    }
    function RanOlderNum(num, range) {//在0~(range-1)范围内生成一个长度为num的数组，并由小到大排列，若要由大到小可以反转数组
        var nums = [num];
        for (let i = 0; i < num; i++) {
            nums[i] = Math.floor(Math.random() * range);
        }
        for (let i = num; i > 0; i--) {
            for (let j = 0; j < i; j++) {
                if (nums[j] > nums[j + 1]) {
                    var temp = nums[j];
                    nums[j] = nums[j + 1];
                    nums[j + 1] = temp;
                }
            }
        }
        return nums;
    }
    function chooseWant(num, range, qiwang) {//检测数值是否满足条件，返回满足条件的值
        var cho = RanOlderNum(num, range); var tot = 0;
        for (let i = 0; i < num; i++) {
            tot += cho[i];
        }
        if (num * range * 2 > qiwang) {
            while (tot < qiwang) {
                cho = RanOlderNum(num, range); tot = 0;
                for (let i = 0; i < num; i++) {
                    tot += cho[i];
                }
            }
        } else {
            while (tot > qiwang) {
                cho = RanOlderNum(num, range); tot = 0;
                for (let i = 0; i < num; i++) {
                    tot += cho[i];
                }
            }
        }
        return cho;
    }
    //重置信息
    function ClearTiles() {
        StartRanMap(50, 50, 0.6);
        ditu = localStorage.tiles.split(","); jiditu = 0;//将地图信息保存到二维数组
        for (let i = 0; i < 50; i++) {
            for (let o = 0; o < 50; o++) {
                tiles[i][o] = ditu[jiditu]; jiditu++;
            }
        }
        x = localStorage.x; y = localStorage.y; home = [x, y];
        ReShow();
    }
    function Up() {
        if (tiles[x][y - 1] == "水") {
            document.getElementById("geZiShu").innerHTML = "前面是水，不能前进了"
        } else if (y - 1 == -1) {
            document.getElementById("geZiShu").innerHTML = "到达了地图边界"
        } else { y--; document.getElementById("geZiShu").innerHTML = "向北前进了一格"; ReShow(); }
    }
    function Down() {
        if (tiles[x][y + 1] == "水") {
            document.getElementById("geZiShu").innerHTML = "前面是水，不能前进了"
        } else if (y + 1 == tiles[0].length) {
            document.getElementById("geZiShu").innerHTML = "到达了地图边界"
        } else { y++; document.getElementById("geZiShu").innerHTML = "向南前进了一格"; ReShow(); }
    }
    function Left() {
        if (tiles[x - 1][y] == "水") {
            document.getElementById("geZiShu").innerHTML = "前面是水，不能前进了"
        } else if (x - 1 == -1) {
            document.getElementById("geZiShu").innerHTML = "到达了地图边界"
        } else { x--; document.getElementById("geZiShu").innerHTML = "向西前进了一格"; ReShow(); }
    }
    function Right() {
        if (tiles[x + 1][y] == "水") {
            document.getElementById("geZiShu").innerHTML = "前面是水，不能前进了"
        } else if (x + 1 == tiles.length) {
            document.getElementById("geZiShu").innerHTML = "到达了地图边界"
        } else { x++; document.getElementById("geZiShu").innerHTML = "向东前进了一格"; ReShow(); }
    }  
</script>

</html>